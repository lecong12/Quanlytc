<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <?!= include('Css'); ?>
  
  <style>
    /* LAYOUT CH√çNH */
    body { background-color: #d1d8e0; font-family: 'Segoe UI', sans-serif; height: 100vh; margin: 0; overflow: hidden; }
    
    /* KHUNG APP: M·ªü r·ªông l√™n 1500px tr√™n Desktop */
    .app-container { 
      display: flex; 
      flex-direction: column; 
      height: 100vh; 
      padding: 10px; 
      margin: 0 auto; 
      max-width: 1000px; /* ƒê√£ tƒÉng ƒë·ªô r·ªông */
      background: #f8f9fa; 
      box-shadow: 0 0 30px rgba(0,0,0,0.2);
    }
    
    /* C·ªê ƒê·ªäNH PH·∫¶N ƒê·∫¶U */
    .sticky-top-section { flex-shrink: 0; background: inherit; z-index: 1020; padding-bottom: 10px; }

    /* DASHBOARD */
    .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
    .stat-card { padding: 12px 5px; border-radius: 12px; color: white; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .stat-card small { font-size: 11px; display: block; text-transform: uppercase; opacity: 0.9; }
    .stat-card b { font-size: 16px; }

    /* B·∫¢NG D·ªÆ LI·ªÜU CU·ªòN - ƒê√É FIX H√ÄNG M·ªéNG & C·ªòT G·ªåN */
.table-wrap { 
  flex-grow: 1; 
  overflow-y: auto; 
  overflow-x: auto; 
  background: white; 
  border-radius: 12px; 
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  position: relative;
}

table { 
  width: 100%; 
  font-size: 15px;      /* Ch·ªØ to theo y√™u c·∫ßu tr∆∞·ªõc ƒë√≥ */
  border-collapse: collapse; 
  min-width: 700px;
  table-layout: fixed; /* üîë √âp c·ªë ƒë·ªãnh chi·ªÅu r·ªông c·ªôt */
}

/* C·∫•u h√¨nh ƒë·ªô r·ªông c√°c c·ªôt (T·ªïng 100%) */
table th:nth-child(1) { width: 30px; } /* Ng√†y */
table th:nth-child(2) { width: 15px;  } /* Lo·∫°i */
table th:nth-child(3) { width: 50px;  } /* auto l√† N·ªôi dung (t·ª± gi√£n) */
table th:nth-child(4) { width: 30px; } /* S·ªë ti·ªÅn */
table th:nth-child(5) { width: 90px;  } /* Thao t√°c */

thead th { 
  position: sticky; 
  top: 0; 
  background-color: #2d3436 !important; 
  color: white !important; 
  z-index: 10; 
  padding: 4px 8px;    /* üîë Gi·∫£m chi·ªÅu cao ti√™u ƒë·ªÅ */
  font-size: 12px;
  text-transform: uppercase;
}

/* üîë QUAN TR·ªåNG: Gi·∫£m padding c·ªßa c√°c √¥ d·ªØ li·ªáu ƒë·ªÉ h√†ng c·ª±c m·ªèng */
#tb td {
  padding: 2px 8px !important; 
  line-height: 1.2;
  border-bottom: 1px solid #eee;
  vertical-align: middle;
  white-space: nowrap;        /* Gi·ªØ n·ªôi dung 1 h√†ng */
  overflow: hidden;           /* N·∫øu d√†i qu√° s·∫Ω ·∫©n */
  text-overflow: ellipsis;    /* Hi·ªán d·∫•u ... n·∫øu d√†i */
}

/* Cho ph√©p c·ªôt N·ªôi dung ƒë∆∞·ª£c xu·ªëng d√≤ng n·∫øu c·∫ßn, c√°c c·ªôt kh√°c gi·ªØ 1 d√≤ng */
#tb td:nth-child(3) {
  white-space: normal; 
}

    /* MODAL */
    .modal-custom {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      display: none; align-items: center; justify-content: center; z-index: 2050;
    }
    .modal-custom.active { display: flex; }
    .modal-box { width: 92%; max-width: 450px; background: white; padding: 25px; border-radius: 20px; }

    /* TI·ªÜN √çCH */
    input, select { font-size: 16px !important; }
    .btn-sm-custom { padding: 6px 2px; font-size: 12px; font-weight: bold; }
    .disabled { opacity: 0.5; pointer-events: none; }

    @media (min-width: 992px) {
      body { padding: 15px 0; }
      .app-container { border-radius: 20px; height: calc(100vh - 30px); }
    }
  </style>
</head>
<body>

<div class="app-container">

  <div class="sticky-top-section">
    <header class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="fw-bold m-0 text-primary"><i class="bi bi-bank"></i> QU·∫¢N L√ù THU CHI</h5>
      <button id="btnLogin" class="btn btn-primary btn-sm px-3 fw-bold" onclick="toggleLogin()">ƒêƒÇNG NH·∫¨P</button>
    </header>

    <section class="dashboard-grid">
      <div class="stat-card bg-success"><small>T·ªïng Thu</small><b id="sThu">0</b></div>
      <div class="stat-card bg-danger"><small>T·ªïng Chi</small><b id="sChi">0</b></div>
      <div class="stat-card" style="background-color: #6f42c1;"><small>T·ªìn Qu·ªπ</small><b id="sTon">0</b></div>
    </section>

    <div class="bg-light p-2 rounded border mb-2">
      <div class="row g-2">
        <div class="col-6">
          <select id="f_type" class="form-select form-select-sm">
            <option value="">-- T·∫•t c·∫£ lo·∫°i --</option>
            <option value="Thu">Thu</option>
            <option value="Chi">Chi</option>
          </select>
        </div>
        <div class="col-6">
          <select id="f_mode" class="form-select form-select-sm" onchange="onModeChange()">
            <option value="all">T·∫•t c·∫£ th·ªùi gian</option>
            <option value="date">Theo ng√†y</option>
            <option value="range">Kho·∫£ng ng√†y</option>
            <option value="month">Theo th√°ng</option>
            <option value="quarter">Theo qu√Ω</option>
            <option value="year">Theo nƒÉm</option>
          </select>
        </div>
      </div>
      
      <div class="row g-2 mt-1">
        <div class="col-6" id="f_date_from_row" style="display:none">
          <label class="small fw-bold" id="lbl_from">Ng√†y</label>
          <input type="date" id="f_from" class="form-control form-control-sm">
        </div>
        <div class="col-6" id="f_date_to_row" style="display:none">
          <label class="small fw-bold">ƒê·∫øn ng√†y</label>
          <input type="date" id="f_to" class="form-control form-control-sm">
        </div>
        <div class="col-6" id="f_year_row" style="display:none">
          <label class="small fw-bold">NƒÉm</label>
          <select id="f_year" class="form-select form-select-sm"></select>
        </div>
        <div class="col-6" id="f_month_from_row" style="display:none">
          <label class="small fw-bold" id="lbl_m_from">Th√°ng</label>
          <select id="f_month_from" class="form-select form-select-sm"></select>
        </div>
        <div class="col-6" id="f_month_to_row" style="display:none">
          <label class="small fw-bold">ƒê·∫øn th√°ng</label>
          <select id="f_month_to" class="form-select form-select-sm"></select>
        </div>
        <div class="col-6" id="f_quarter_row" style="display:none">
          <label class="small fw-bold">Qu√Ω</label>
          <select id="f_quarter" class="form-select form-select-sm">
            <option value="1">Qu√Ω 1</option><option value="2">Qu√Ω 2</option>
            <option value="3">Qu√Ω 3</option><option value="4">Qu√Ω 4</option>
          </select>
        </div>
      </div>
    </div>

    <div class="row g-1 mb-2">
      <div class="col-4">
        <input id="searchBox" class="form-control form-control-sm" placeholder="T√¨m nhanh..." oninput="searchTable()">
      </div>
      <div class="col-2">
        <button class="btn btn-info btn-sm w-100 text-white fw-bold" onclick="applyFilter()">L·ªåC</button>
      </div>
      <div class="col-3">
        <button class="btn btn-outline-secondary btn-sm w-100 fw-bold" onclick="clearFilter()">X√ìA L·ªåC</button>
      </div>
      <div class="col-3">
        <button id="btnAdd" class="btn btn-success btn-sm w-100 fw-bold disabled" onclick="openModal()" disabled>+ TH√äM</button>
      </div>
    </div>

    <div class="row g-1">
      <div class="col-3"><button class="btn btn-outline-success btn-sm-custom w-100" onclick="exportExcel()">Excel</button></div>
      <div class="col-3"><button class="btn btn-outline-danger btn-sm-custom w-100" onclick="exportPDF()">PDF</button></div>
    <div class="col-6">
  <a id="sheetLink" href="https://docs.google.com/spreadsheets/d/1GSfropAOsuXe0IBwDCse32WeXTO63YPB_gqBmHr0mBY/edit?gid=998902108#gid=998902108" target="_blank" 
     class="btn btn-outline-success btn-sm-custom w-100 disabled">
     <i class="bi bi-google"></i> Google Sheets
  </a>
  </div>


  <div class="table-wrap">
    <table class="table table-hover align-middle" id="mainTable">
      <thead>
        <tr>
          <th>Ng√†y</th>
          <th>Lo·∫°i</th>
          <th>N·ªôi dung</th>
          <th style="text-align:right">S·ªë ti·ªÅn</th>
          <th style="text-align:center">Thao t√°c</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>
</div>

<div id="modalForm" class="modal-custom" onclick="closeModalOutside(event)">
  <div class="modal-box shadow" onclick="event.stopPropagation()">
    <h4 id="modalTitle" class="fw-bold mb-3 text-center text-primary">C·∫¨P NH·∫¨T D·ªÆ LI·ªÜU</h4>
    <div class="mb-2"><label class="small fw-bold">Ng√†y</label><input id="m_date" type="date" class="form-control"></div>
    <div class="mb-2">
      <label class="small fw-bold">Lo·∫°i</label>
      <select id="m_type" class="form-select"><option value="Thu">Thu</option><option value="Chi">Chi</option></select>
    </div>
    <div class="mb-2"><label class="small fw-bold">N·ªôi dung</label><input id="m_content" class="form-control" placeholder="L√Ω do thu/chi..."></div>
    <div class="mb-4"><label class="small fw-bold">S·ªë ti·ªÅn</label><input id="m_amount" type="number" class="form-control" placeholder="0"></div>
    <div class="d-flex gap-2">
      <button class="btn btn-primary btn-lg flex-grow-1 fw-bold shadow-sm" onclick="modalSave()">L∆ØU</button>
      <button class="btn btn-secondary btn-lg fw-bold px-4" onclick="closeModal()">ƒê√ìNG</button>
    </div>
  </div>
</div>

<div id="loginModal" class="modal-custom" onclick="closeLoginOutside(event)">
  <div class="modal-box shadow" style="max-width: 320px;" onclick="event.stopPropagation()">
    <h4 class="text-center fw-bold mb-3">X√ÅC TH·ª∞C</h4>
    <input id="u" class="form-control mb-2" placeholder="T√†i kho·∫£n">
    <input id="p" type="password" class="form-control mb-4" placeholder="M·∫≠t kh·∫©u">
    <button class="btn btn-primary w-100 py-2 fw-bold" onclick="doLogin()">ƒêƒÇNG NH·∫¨P</button>
  </div>
</div>

<div id="toast" class="toast-custom"></div>
<?!= include('Javascript'); ?>
</body>
</html>