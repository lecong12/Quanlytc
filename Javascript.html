<script>
/* ============================================================
    1. KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C & TI·ªÜN √çCH (STATE & UTILS)
    ============================================================ */
let isLoggedIn = false;      // TR·∫†NG TH√ÅI ƒêƒÇNG NH·∫¨P CHUNG
let lastRows = [];           // D·ªØ li·ªáu g·ªëc
let editId = null;           // L∆∞u ID d√≤ng ƒëang s·ª≠a
let currentAction = 'add';   // Tr·∫°ng th√°i: 'add' hay 'edit'
let currentFilterDisplay = 'To√†n b·ªô c√°c kho·∫£n thu chi'; // Bi·∫øn l∆∞u ti√™u ch√≠ l·ªçc

const $ = i => document.getElementById(i);
// ƒê·ªäNH D·∫†NG: S·ª≠ d·ª•ng 'vi-VN' ƒë·ªÉ c√≥ d·∫•u ch·∫•m (.) ph√¢n c√°ch h√†ng ngh√¨n
const fmt = n => new Intl.NumberFormat('vi-VN').format(n || 0);

/* ============================================================
    2. QU·∫¢N L√ù ƒêƒÇNG NH·∫¨P (AUTHENTICATION)
    ============================================================ */
function toggleLogin() {
    if (isLoggedIn) {
        // TR·∫†NG TH√ÅI ƒêƒÇNG XU·∫§T: G·ªçi h√†m logout() ngay l·∫≠p t·ª©c m√† kh√¥ng c·∫ßn x√°c nh·∫≠n
        logout(); 
    } else {
        // TR·∫†NG TH√ÅI ƒêƒÇNG NH·∫¨P: M·ªü modal
        $('loginModal').classList.add('active');
    }
}

function doLogin() {
    const user = $('u').value;
    const pass = $('p').value;
    if (!user || !pass) return showToast('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß', 'orange');

    google.script.run.withSuccessHandler(r => {
        if (!r.ok) return showToast('Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u', '#dc2626');
        
        isLoggedIn = true;
        const btn = $('btnLogin');
        if (btn) {
            btn.innerText = 'ƒêƒÉng xu·∫•t';
            btn.classList.add('logged');
        }
        
        $('loginModal').classList.remove('active');
        $('u').value = ''; 
        $('p').value = '';

        updateUI(); 
        renderTable(lastRows); 
        showToast('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', '#16a34a');
    }).login(user, pass);
}

function logout() {
    isLoggedIn = false;
    const btn = $('btnLogin');
    if (btn) {
        btn.innerText = 'ƒêƒÉng nh·∫≠p';
        btn.classList.remove('logged');
    }
    
    updateUI(); 
    renderTable(lastRows); 
    showToast('ƒê√£ ƒëƒÉng xu·∫•t', '#666');
}

function closeLogin() {
    $('loginModal').classList.remove('active');
}

function closeLoginOutside(e) {
    if (e.target.id === 'loginModal') closeLogin();
}

/* ============================================================
    3. T·∫¢I D·ªÆ LI·ªÜU & HI·ªÇN TH·ªä B·∫¢NG (DATA LOADING & RENDERING)
    ============================================================ */
// S·ª¨A L·ªñI LOAD: ƒê·∫£m b·∫£o lu·ªìng ch·∫°y ·ªïn ƒë·ªãnh
function loadAll() {
    // Hi·ªÉn th·ªã th√¥ng b√°o ƒëang t·∫£i (t√πy ch·ªçn)
    // showToast("ƒêang t·∫£i d·ªØ li·ªáu...", "#007bff"); 
    google.script.run
        .withSuccessHandler(function(data) {
            lastRows = data; 
            currentFilterDisplay = 'To√†n b·ªô c√°c kho·∫£n thu chi'; // G√°n ti√™u ch√≠ m·∫∑c ƒë·ªãnh
            renderTable(data); 
            updateStats(data); 
            // showToast("T·∫£i d·ªØ li·ªáu th√†nh c√¥ng", "#16a34a");
        })
        .withFailureHandler(function(err) {
            // R·∫•t QUAN TR·ªåNG: B·∫Øt l·ªói n·∫øu h√†m Apps Script kh√¥ng ch·∫°y
            showToast("L·ªñI: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ban ƒë·∫ßu. Vui l√≤ng ki·ªÉm tra file Code.gs v√† tri·ªÉn khai l·∫°i Web App. Chi ti·∫øt: " + err.message, "#dc2626");
        })
        .getDataFromServer({mode: 'all'}); 
}

function renderTable(rows) {
    const tbody = $('tb');
    tbody.innerHTML = ''; 
    
    rows.forEach(r => {
        const rowClass = (r.type === 'Chi' || r.type === 'chi') ? 'tr-chi' : '';
        const disClass = isLoggedIn ? '' : 'icon-disabled';
        const loginTitle = isLoggedIn ? '' : 'title="Y√™u c·∫ßu ƒëƒÉng nh·∫≠p"';
        const pointerStyle = isLoggedIn ? '' : 'style="pointer-events:none; opacity:0.35;"';

        // L∆ØU √ù: ƒê·∫£m b·∫£o amount ƒë∆∞·ª£c l√†m s·∫°ch tr∆∞·ªõc khi g·ªçi fmt, m·∫∑c d√π ·ªü ƒë√¢y r.amount l√† t·ª´ sheet n√™n th∆∞·ªùng l√† s·ªë ho·∫∑c chu·ªói s·ªë.
        const amountDisplay = fmt(r.amount); 

        tbody.insertAdjacentHTML('beforeend', `
            <tr class="${rowClass}">
                <td style="white-space: nowrap;">${r.date}</td>
                <td style="font-weight: 500;">${r.type}</td>
                <td>${r.content}</td>
                <td style="text-align:right;">${amountDisplay}</td>
                <td class="action-cell">
                    <button class="${disClass}" ${loginTitle} ${pointerStyle} onclick="if(isLoggedIn) openEditModal('${r.id}')">‚úèÔ∏è</button>
                    <button class="${disClass}" ${loginTitle} ${pointerStyle} onclick="if(isLoggedIn) del('${r.id}')">üóë</button>
                </td>
            </tr>
        `);
    });
}

/* ============================================================
    4. T√åM KI·∫æM & TR·∫†NG TH√ÅI N√öT (SEARCH & UI STATE)
    ============================================================ */
function searchTable(){
    const k = $('searchBox').value.toLowerCase();
    document.querySelectorAll('#tb tr').forEach(tr=>{
        tr.style.display = tr.innerText.toLowerCase().includes(k) ? '' : 'none';
    });
}

function updateUI() {
    const btnAdd = $('btnAdd');
    const btnSheet = $('sheetLink');
    const btnExcel = $('btnExportExcel'); // ID n√∫t Excel
    const btnPDF = $('btnExportPDF');     // ID n√∫t PDF
    const btnEmail = $('btnOpenEmail');   // ID n√∫t Email
    const loginMsg = "Y√™u c·∫ßu ƒëƒÉng nh·∫≠p";

    // Gom c√°c n√∫t ch·ª©c nƒÉng v√†o m·ªôt m·∫£ng ƒë·ªÉ x·ª≠ l√Ω h√†ng lo·∫°t
    const actionBtns = [
        { el: btnAdd, type: 'button' },
        { el: btnExcel, type: 'button' },
        { el: btnPDF, type: 'button' },
        { el: btnEmail, type: 'button' },
        { el: btnSheet, type: 'link' }
    ];

    actionBtns.forEach(item => {
        if (!item.el) return;

        if (isLoggedIn) {
            // M·ªû KH√ìA
            item.el.classList.remove('disabled');
            item.el.title = "";
            if (item.type === 'button') {
                item.el.disabled = false;
                // X√≥a b·ªè ch·∫∑n click ·ªü th·∫ª cha (n·∫øu c√≥)
                if (item.el.parentElement) item.el.parentElement.onclick = null;
            } else {
                item.el.style.pointerEvents = "auto";
                item.el.style.opacity = "1";
            }
        } else {
            // KH√ìA L·∫†I
            item.el.classList.add('disabled');
            item.el.title = loginMsg;
            if (item.type === 'button') {
                item.el.disabled = true;
                // Khi click v√†o v√πng n√∫t b·ªã kh√≥a th√¨ hi·ªán th√¥ng b√°o
                if (item.el.parentElement) {
                    item.el.parentElement.onclick = () => { showToast(loginMsg, "orange"); };
                }
            } else {
                item.el.style.pointerEvents = "none";
                item.el.style.opacity = "0.5";
            }
        }
    });
}

/* ============================================================
    5. TH√äM, S·ª¨A, X√ìA D·ªÆ LI·ªÜU (CRUD OPERATIONS)
    ============================================================ */

function openModal(){
    if(!isLoggedIn) return showToast('C·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th√™m d·ªØ li·ªáu', 'orange'); 
    
    currentAction = 'add'; 
    editId = null;
    $('modalTitle').innerText = 'TH√äM D·ªÆ LI·ªÜU';
    $('btnSave').innerText = 'L∆ØU'; 
    
    $('m_date').value = new Date().toISOString().slice(0,10);
    $('m_type').value = 'Chi';
    $('m_content').value = '';
    $('m_amount').value = ''; 
    
    $('modalForm').classList.add('active');
}

function openEditModal(id){
    if(!isLoggedIn) return showToast('C·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠a d·ªØ li·ªáu', 'orange'); 
    
    google.script.run.withSuccessHandler(d=>{
        if(!d) return alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu');
        
        currentAction = 'edit'; 
        editId = d.id;
        $('modalTitle').innerText = 'S·ª¨A D·ªÆ LI·ªÜU';
        $('btnSave').innerText = 'C·∫¨P NH·∫¨T'; 
        
        $('m_date').value = d.date;
        $('m_type').value = d.type;
        $('m_content').value = d.content;
        
        const amountInput = $('m_amount');
        amountInput.value = d.amount; 
        formatAmount(amountInput);    
        
        $('modalForm').classList.add('active');
    }).getItemById(id);
}

function modalSave() {
    if (!isLoggedIn) return showToast('C·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u', 'orange'); 
    
    const btn = $('btnSave');
    if (btn && btn.disabled) return; 

    const rawAmount = $('m_amount').value.replace(/\D/g, ''); 
    
    if (!rawAmount || !$('m_date').value) {
        return showToast("Vui l√≤ng nh·∫≠p Ng√†y v√† S·ªë ti·ªÅn", 'red');
    }

    const o = {
        id: editId,
        date: $('m_date').value,
        type: $('m_type').value,
        content: $('m_content').value,
        amount: Number(rawAmount) 
    };

    if (btn) {
        btn.disabled = true;
        btn.innerText = "ƒêang x·ª≠ l√Ω...";
        btn.style.opacity = "0.5";
    }

    const fn = currentAction === 'edit' ? 'updateRow' : 'addRow';
    const msg = currentAction === 'edit' ? 'ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu' : 'ƒê√£ th√™m d·ªØ li·ªáu th√†nh c√¥ng';
    const color = currentAction === 'edit' ? '#2563eb' : '#16a34a';
    const originalText = currentAction === 'edit' ? "C·∫¨P NH·∫¨T" : "L∆ØU";

    google.script.run
        .withSuccessHandler(() => {
            closeModal();
            applyFilter();
            showToast(msg, color); 

            if (btn) {
                btn.disabled = false;
                btn.innerText = originalText;
                btn.style.opacity = "1";
            }
        })
        .withFailureHandler((err) => {
            showToast("L·ªói: " + err.message, "#dc2626");
            if (btn) {
                btn.disabled = false;
                btn.innerText = "Th·ª≠ l·∫°i";
                btn.style.opacity = "1";
            }
        })[fn](o);
}

function closeModal(){
    $('modalForm').classList.remove('active');
}

function closeModalOutside(e){
    if(e.target.id === 'modalForm') closeModal();
}

function del(id){
    if(!isLoggedIn) return showToast('C·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ x√≥a', 'orange'); 
    
    if(!confirm('Ch·∫Øc ch·∫Øn x√≥a d√≤ng n√†y?')) return;
    google.script.run.withSuccessHandler(() => {
        loadAll();
        showToast("ƒê√£ x√≥a d·ªØ li·ªáu", "#dc2626");
    }).deleteRow(id);
}

/* ============================================================
    6. LOGIC B·ªò L·ªåC N√ÇNG CAO (FILTER SYSTEM)
    ============================================================ */
function initFilterDropdowns() {
    const yearSelect = $('f_year');
    const monthFrom = $('f_month_from');
    const monthTo = $('f_month_to');

    if (yearSelect) {
        yearSelect.innerHTML = '';
        const currentYear = new Date().getFullYear();
        for (let i = currentYear - 5; i <= currentYear + 5; i++) {
            let opt = document.createElement('option');
            opt.value = i; opt.innerHTML = i;
            if (i === currentYear) opt.selected = true;
            yearSelect.appendChild(opt);
        }
    }

    if (monthFrom && monthTo) {
        monthFrom.innerHTML = ''; monthTo.innerHTML = '';
        for (let i = 1; i <= 12; i++) {
            let optFrom = document.createElement('option');
            let optTo = document.createElement('option');
            optFrom.value = i; optFrom.innerHTML = 'Th√°ng ' + i;
            optTo.value = i; optTo.innerHTML = 'Th√°ng ' + i;
            monthFrom.appendChild(optFrom);
            monthTo.appendChild(optTo);
        }
        const currentMonth = new Date().getMonth() + 1;
        monthFrom.value = 1; 
        monthTo.value = currentMonth; 
    }
}

function onModeChange() {
    const mode = $('f_mode').value;
    const config = {
        'f_date_from_row': ['date', 'range'],
        'f_date_to_row': ['range'],
        'f_year_row': ['month', 'quarter', 'year'],
        'f_month_from_row': ['month'],
        'f_month_to_row': ['month'],
        'f_quarter_row': ['quarter']
    };

    for (let id in config) {
        const el = $(id);
        if (el) el.style.display = config[id].includes(mode) ? 'block' : 'none';
    }

    const lblFrom = $('lbl_from');
    if (lblFrom) lblFrom.innerText = (mode === 'range') ? 'T·ª´ ng√†y' : 'Ng√†y';
}

function createFilterCriteria(filterData) {
    let criteria = '';
    const typeText = filterData.type && filterData.mode !== 'all' ? `Lo·∫°i: ${filterData.type} cho ` : '';

    if (filterData.mode === 'all') {
        criteria = 'To√†n b·ªô c√°c kho·∫£n thu chi';
    } else if (filterData.mode === 'year') {
        criteria = `NƒÉm ${filterData.year}`;
    } else if (filterData.mode === 'month') {
        const y = filterData.year;
        const mFrom = filterData.monthFrom;
        const mTo = filterData.monthTo;
        if (mFrom === mTo) {
            criteria = `Th√°ng ${mFrom} nƒÉm ${y}`;
        } else {
            criteria = `T·ª´ th√°ng ${mFrom} ƒë·∫øn th√°ng ${mTo} nƒÉm ${y}`;
        }
    } else if (filterData.mode === 'quarter') {
        criteria = `Qu√Ω ${filterData.quarter} nƒÉm ${filterData.year}`;
    } else if (filterData.mode === 'date') {
        criteria = `Ng√†y ${filterData.dateFrom}`;
    } else if (filterData.mode === 'range') {
        criteria = `T·ª´ ng√†y ${filterData.dateFrom} ƒë·∫øn ng√†y ${filterData.dateTo}`;
    }
    
    return filterData.mode === 'all' ? criteria : typeText + criteria;
}

function applyFilter() {
    const filterData = {
        type: $('f_type').value,
        mode: $('f_mode').value,
        dateFrom: $('f_from').value,
        dateTo: $('f_to').value,
        year: $('f_year').value,
        monthFrom: $('f_month_from').value,
        monthTo: $('f_month_to').value,
        quarter: $('f_quarter').value
    };

    currentFilterDisplay = createFilterCriteria(filterData);
    
    // Ki·ªÉm tra n·∫øu s·ª± ki·ªán ƒë·∫øn t·ª´ n√∫t b·∫•m th√¨ m·ªõi ƒë·ªïi text n√∫t
    const btn = event && event.currentTarget ? event.currentTarget : null;
    const originalText = btn ? btn.innerText : "";
    if(btn) {
        btn.innerText = "ƒêang l·ªçc...";
        btn.disabled = true;
    }

    google.script.run
        .withSuccessHandler(function(data) {
            if (data && data.length > 0) {
                // --- TH√äM LOGIC S·∫ÆP X·∫æP V√ÄO ƒê√ÇY ---
                data.sort((a, b) => {
                    // C·ªôt B (index 1) l√† Ng√†y th√°ng
                    const parseDate = (v) => {
                        if (!v) return 0;
                        if (v instanceof Date) return v.getTime();
                        // N·∫øu l√† chu·ªói dd/mm/yyyy
                        if (typeof v === 'string' && v.includes('/')) {
                            const p = v.split('/');
                            return new Date(p[2], p[1]-1, p[0]).getTime();
                        }
                        return new Date(v).getTime() || 0;
                    };
                    return parseDate(b.date || b[1]) - parseDate(a.date || a[1]);
                });
            }

            renderTable(data); 
            updateStats(data); 

            if(btn) {
                btn.innerText = originalText;
                btn.disabled = false;
            }
            showToast("ƒê√£ l·ªçc d·ªØ li·ªáu", "#007bff");
        })
        .withFailureHandler(function(err) {
            if(btn) {
                btn.innerText = originalText;
                btn.disabled = false;
            }
            showToast("L·ªói l·ªçc: " + err.message, "red");
        })
        .getDataFromServer(filterData); 
}

function updateStats(dataList) {
    let thu = 0, chi = 0;
    dataList.forEach(r => {
        let val = Number(r.amount.toString().replace(/\./g, '').replace(/,/g, '')) || 0; 
        if (r.type === 'Thu') thu += val;
        else if (r.type === 'Chi') chi += val;
    });

    const ton = thu - chi;
    $('sThu').innerText = fmt(thu);
    $('sChi').innerText = fmt(chi);
    $('sTon').innerText = fmt(ton);

    const cardTon = $('sTon').parentElement;
    if (ton < 0) {
        cardTon.style.backgroundColor = "#dc2626"; 
    } else {
        cardTon.style.backgroundColor = "#6f42c1"; 
    }
}

function clearFilter() {
    if($('searchBox')) $('searchBox').value = '';
    if($('f_type')) $('f_type').value = '';
    if($('f_mode')) $('f_mode').value = 'all';
    
    onModeChange(); 
    
    currentFilterDisplay = 'To√†n b·ªô c√°c kho·∫£n thu chi';
    
    if (lastRows && lastRows.length > 0) {
        renderTable(lastRows); 
        updateStats(lastRows); 
    } else {
        loadAll(); 
    }
    
    showToast(" ƒê√£ x√≥a b·ªô l·ªçc, hi·ªÉn th·ªã t·∫•t c·∫£ d·ªØ li·ªáu", "#e67e22");
}

/* ============================================================
    7. XU·∫§T D·ªÆ LI·ªÜU (EXPORT EXCEL & PDF)
    ============================================================ */
function exportExcel() {
    try {
        const data = [];
        data.push(["B√ÅO C√ÅO THU CHI"]);
        data.push([]); 
        
        data.push(["Ti√™u ch√≠ l·ªçc:", currentFilterDisplay]);
        data.push([]); 

        const tongThu = $('sThu') ? $('sThu').innerText : "0";
        const tongChi = $('sChi') ? $('sChi').innerText : "0";
        const tonQuy = $('sTon') ? $('sTon').innerText : "0";

        data.push(["T·ªïng thu:", tongThu]);
        data.push(["T·ªïng chi:", tongChi]);
        data.push(["T·ªìn qu·ªπ:", tonQuy]);
        data.push([]); 

        data.push(["Ng√†y th√°ng", "Lo·∫°i", "N·ªôi dung", "S·ªë ti·ªÅn"]);

        const rows = document.getElementById("tb").querySelectorAll("tr");
        rows.forEach(row => {
            const cols = row.querySelectorAll("td");
            if (cols.length >= 4) {
                data.push([
                    cols[0].innerText.trim(), 
                    cols[1].innerText.trim(), 
                    cols[2].innerText.trim(), 
                    cols[3].innerText.trim()
                ]);
            }
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 3 } }]; 
        ws['!cols'] = [{ wch: 18 }, { wch: 10 }, { wch: 45 }, { wch: 18 }];

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "B√°o c√°o");
        
        const now = new Date();
        const dateStr = now.getDate().toString().padStart(2, '0') + '-' + 
                        (now.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                        now.getFullYear();
        const fileName = `Bao_Cao_Thu_Chi_${dateStr}.xlsx`;
        XLSX.writeFile(wb, fileName);

        showToast("ƒê√£ xu·∫•t Excel k√®m th√¥ng tin t·ªïng k·∫øt!", "#16a34a");
    } catch (e) {
        console.error(e);
        alert("L·ªói xu·∫•t Excel: " + e.message);
    }
}

function exportPDF() {
    const tbody = document.getElementById('tb');
    const rows = tbody.querySelectorAll('tr');

    if (rows.length === 0) {
        showToast("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t PDF!", "#dc2626");
        return;
    }

    const thu = $('sThu') ? $('sThu').innerText : "0";
    const chi = $('sChi') ? $('sChi').innerText : "0";
    const ton = $('sTon') ? $('sTon').innerText : "0";
    const criteriaText = currentFilterDisplay;
    const criteriaTextLower = criteriaText.toLowerCase();

    const element = document.createElement('div');
    element.innerHTML = `
        <h2 style="text-align: center; text-transform: uppercase; margin-bottom: 5px; font-weight: bold; font-family: Arial, sans-serif; font-size: 16px;">
            B√ÅO C√ÅO THU CHI
        </h2>
        
        <p style="text-align: center; font-family: Arial, sans-serif; font-size: 12px; margin-bottom: 15px; font-weight: bold;">
            ${criteriaTextLower}
        </p> 
        
        <div style="margin-bottom: 15px; font-family: Arial, sans-serif; font-size: 12px; line-height: 1.5;">
            <div><b>T·ªïng thu:</b> ${thu}</div>
            <div><b>T·ªïng chi:</b> ${chi}</div>
            <div style="color: ${ton.includes('-') ? '#dc2626' : '#6f42c1'}; font-weight: bold;">
                <b>T·ªìn qu·ªπ:</b> ${ton}
            </div>
        </div>

        <style>
            table { 
                width: 100%; 
                border-collapse: collapse; 
                table-layout: fixed; /* B·∫ÆT BU·ªòC ƒë·ªÉ chi·ªÅu r·ªông c·ªôt ho·∫°t ƒë·ªông */
                font-family: Arial, sans-serif; 
                font-size: 11px;
            }
            th, td { 
                border: 0.5pt solid #ccc; 
                padding: 4px; 
                font-size: 11px;
                word-wrap: break-word; 
                font-weight: normal !important; 
            }
            th { 
                background-color: #f8f9fa; 
                text-transform: uppercase; 
                text-align: center; 
                font-weight: bold !important; 
                color: #000; 
            }
            .text-red-only { color: #b91c1c !important; font-weight: normal !important; }
            .center { text-align: center; }
            .right { text-align: right; }
            
            .signature-section {
                margin-top: 20px;
                display: flex;
                flex-direction: column;
                align-items: flex-end; 
                padding-right: 50px;
                font-family: Arial, sans-serif;
            }
            .signature-title { font-size: 12px; margin-bottom: 50px; text-align: center; } 
            .signature-name { font-size: 13px; font-weight: bold; text-align: center; }
        </style>
    `;

    let tableHTML = `
        <table>
            <thead>
                <tr>
                    <th style="width: 15%">Ng√†y</th>
                    <th style="width: 8%">Lo·∫°i</th>
                    <th style="width: 62%">N·ªôi dung</th>
                    <th style="width: 15%">S·ªë ti·ªÅn</th>
                </tr>
            </thead>
            <tbody>
    `;

    rows.forEach(row => {
        const cols = row.querySelectorAll('td');
        if (cols.length >= 4) {
            const typeText = cols[1].innerText.trim();
            const isChi = typeText === 'Chi';
            const rowStyleClass = isChi ? 'class="text-red-only"' : '';
            
            tableHTML += `
                <tr ${rowStyleClass}>
                    <td class="center">${cols[0].innerText}</td>
                    <td class="center">${cols[1].innerText}</td>
                    <td>${cols[2].innerText}</td>
                    <td class="right">${cols[3].innerText}</td>
                </tr>
            `;
        }
    });

    tableHTML += `</tbody></table>`;
    
    const signatureHTML = `
        <div class="signature-section">
            <div class="signature-title">    ...     </div>
            <div class="signature-name">     ...     </div>
        </div>
    `;

    element.innerHTML += tableHTML + signatureHTML;

    const now = new Date();
    const dateStr = now.getDate().toString().padStart(2, '0') + '-' + 
                    (now.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                    now.getFullYear();
    const timeStr = now.getHours().toString().padStart(2, '0') + 'h' + 
                    now.getMinutes().toString().padStart(2, '0');

    const opt = {
        // L·ªÄ TRANG (mm): [tr√™n, tr√°i, d∆∞·ªõi, ph·∫£i]
        margin: [20, 10, 20, 10], 
        filename: `BCTC_${dateStr}_${timeStr}.pdf`, 
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    showToast("ƒêang t·∫°o file PDF...", "#2563eb");
    html2pdf().set(opt).from(element).save();
}
/* ============================================================
    8. TH√îNG B√ÅO & KH·ªûI T·∫†O (TOAST & INIT)
    ============================================================ */
function showToast(msg, color = "#333") {
    const toast = $('toast');
    if (toast) {
        toast.innerText = msg;
        toast.style.backgroundColor = color;
        toast.className = "toast show";
        setTimeout(() => { toast.className = "toast"; }, 1000); 
    }
}

window.addEventListener('DOMContentLoaded', () => {
    updateUI(); 
    loadAll(); // G·ªåI H√ÄM LOAD D·ªÆ LI·ªÜU BAN ƒê·∫¶U
    initFilterDropdowns();
    onModeChange(); 
    
    const btnLogin = $('btnLogin');
    if (btnLogin && !btnLogin.onclick) {
        btnLogin.onclick = toggleLogin;
    }
});

/* ============================================================
    9. PH√ÇN T√ÅCH D·∫§U CH·∫§M H√ÄNG NGH√åN (FORMATTING)
    ============================================================ */
function formatAmount(input) {
  let value = input.value.replace(/\D/g, ''); 
  
  if (value) {
    let formattedValue = new Intl.NumberFormat('vi-VN').format(value); 
    input.value = formattedValue;
  }
}

// Th√™m v√†o b√™n trong window.addEventListener('DOMContentLoaded', ...):
if ($('btnLogin')) {
    $('btnLogin').addEventListener('click', () => setTimeout(autofillLogin, 100));
}
/* ============================================================
    10. T·ª∞ ƒêI·ªÄN TH√îNG TIN ƒêƒÇNG NH·∫¨P
   ============================================================ */
const DEFAULT_USERNAME = "thuy"; 
const DEFAULT_PASSWORD = "1393"; 

function autofillLogin() {
    const usernameInput = $('u'); 
    const passwordInput = $('p'); 

    if (usernameInput && passwordInput) {
        usernameInput.value = DEFAULT_USERNAME;
        passwordInput.value = DEFAULT_PASSWORD;
        passwordInput.focus(); 
        console.log('ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn: thuy / 1393');
    }
}

/* ============================================================
    11. H√ÄM X·ª¨ L√ù G·ª¨I EMAIL TR√äN GIAO DI·ªÜN
   ============================================================ */
function openEmailModal() {
  const modal = $('commonModal');
  if(!modal) return alert("L·ªói: Kh√¥ng t√¨m th·∫•y khung Modal 'commonModal' trong HTML!");
  
  modal.style.display = 'flex';
  $('modalTitle').innerText = "üìß G·ª¨I B√ÅO C√ÅO QUA EMAIL";
  
  const savedEmail = localStorage.getItem('lastUsedEmail') || "";

  // S·ª≠ d·ª•ng innerHTML ƒë·ªÉ d·ª±ng giao di·ªán b√™n trong modal
  const modalBody = $('modalBody');
  const modalFooter = $('modalFooter');
  
  if(modalBody) {
    modalBody.innerHTML = `
      <div style="padding: 15px;">
        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Email ng∆∞·ªùi nh·∫≠n:</label>
        <input type="email" id="txtEmailTarget" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" value="${savedEmail}" placeholder="nhap-email@gmail.com">
        <p style="color: #666; font-size: 11px; margin-top: 8px;">* H·ªá th·ªëng s·∫Ω g·ª≠i to√†n b·ªô b·∫£ng d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã.</p>
      </div>
    `;
  }
  
  if(modalFooter) {
    modalFooter.innerHTML = `
      <button onclick="closeCommonModal()" style="padding: 5px 15px; cursor: pointer;">H·ªßy</button>
      <button onclick="processSendEmail()" id="btnConfirmEmail" style="padding: 5px 15px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">G·ª≠i</button>
    `;
  }
}

function processSendEmail() {
  const emailInput = $('txtEmailTarget') ? $('txtEmailTarget').value.trim() : "";
  if (!emailInput || !emailInput.includes('@')) {
    return showToast("Vui l√≤ng nh·∫≠p ch√≠nh x√°c ƒë·ªãa ch·ªâ Email!", "orange");
  }

  localStorage.setItem('lastUsedEmail', emailInput);

  const btn = $('btnConfirmEmail');
  btn.innerText = "‚è≥ ƒêang g·ª≠i...";
  btn.disabled = true;

  // L·∫•y d·ªØ li·ªáu b·∫£ng
  const tableData = [];
  const rows = document.querySelectorAll("#tb tr");
  rows.forEach(row => {
    const cols = row.querySelectorAll("td");
    if (cols.length >= 4) {
      tableData.push({
        date: cols[0].innerText,
        type: cols[1].innerText,
        content: cols[2].innerText,
        amount: cols[3].innerText
      });
    }
  });

  // üîë L·∫§Y 3 CON S·ªê ƒê√É T√çNH ·ªû B·ªò L·ªåC
  const summary = {
  thu: document.getElementById('sThu').innerText,
  chi: document.getElementById('sChi').innerText,
  ton: document.getElementById('sTon').innerText
};
console.log("D·ªØ li·ªáu t·ªïng g·ª≠i ƒëi:", summary); 

  google.script.run
    .withSuccessHandler(res => {
      btn.innerText = "G·ª≠i";
      btn.disabled = false;
      if (res.ok) {
        showToast("‚úÖ ƒê√£ g·ª≠i Email th√†nh c√¥ng!", "#16a34a");
        closeCommonModal();
      } else {
        alert("‚ùå L·ªói: " + res.error);
      }
    })
    .withFailureHandler(err => {
      btn.innerText = "G·ª≠i";
      btn.disabled = false;
      alert("‚ùå L·ªói k·∫øt n·ªëi: " + err.message);
    })
    // üîë G·ª¨I TH√äM BI·∫æN SUMMARY SANG SERVER
    .sendEmailFromApp(tableData, emailInput, summary); 
}

function closeCommonModal() {
  const modal = $('commonModal');
  if(modal) modal.style.display = 'none';
}

</script>