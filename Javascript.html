<script>
/* ============================================================
   1. KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C & TI·ªÜN √çCH (STATE & UTILS)
   ============================================================ */
let isLoggedIn = false;
let lastRows = [];
let editId = null;

const $ = i => document.getElementById(i);
const fmt = n => new Intl.NumberFormat('vi-VN').format(n || 0);

/* ============================================================
   2. QU·∫¢N L√ù ƒêƒÇNG NH·∫¨P (AUTHENTICATION)
   ============================================================ */
function toggleLogin() {
  if (isLoggedIn) {
    isLoggedIn = false;
    const btn = $('btnLogin');
    btn.innerText = 'ƒêƒÉng nh·∫≠p';
    btn.classList.remove('logged'); 
    
    updateAddBtn();
    renderTable(lastRows);
    showToast('ƒê√£ ƒëƒÉng xu·∫•t', '#666');
    return;
  }
  $('loginModal').classList.add('active');
}

function doLogin() {
  const user = $('u').value;
  const pass = $('p').value;
  if (!user || !pass) return alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß');

  google.script.run.withSuccessHandler(r => {
    if (!r.ok) return alert('Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u');
    isLoggedIn = true;
    const btn = $('btnLogin');
    btn.innerText = 'ƒêƒÉng xu·∫•t';
    btn.classList.add('logged');
    
    $('loginModal').classList.remove('active');
    $('u').value = ''; 
    $('p').value = '';

    updateAddBtn();
    renderTable(lastRows);
    showToast('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', '#16a34a');
  }).login(user, pass);
}

function closeLogin() {
  $('loginModal').classList.remove('active');
}

function closeLoginOutside(e) {
  if (e.target.id === 'loginModal') closeLogin();
}

/* ============================================================
   3. T·∫¢I D·ªÆ LI·ªÜU & HI·ªÇN TH·ªä B·∫¢NG (DATA LOADING & RENDERING)
   ============================================================ */
function loadAll(){
  google.script.run.withSuccessHandler(r=>{
    lastRows = r || [];
    renderTable(lastRows);
  }).listData();

  google.script.run.withSuccessHandler(s=>{
    $('sThu').innerText = fmt(s.thu);
    $('sChi').innerText = fmt(s.chi);
    $('sTon').innerText = fmt(s.ton);
  }).summary();
}

function renderTable(rows) {
  const tbody = $('tb');
  tbody.innerHTML = ''; 
  
  rows.forEach(r => {
    const rowClass = (r.type === 'Chi' || r.type === 'chi') ? 'tr-chi' : '';
    const disClass = isLoggedIn ? '' : 'icon-disabled';
    const loginTitle = isLoggedIn ? '' : 'title="Y√™u c·∫ßu ƒëƒÉng nh·∫≠p"';
    const pointerStyle = isLoggedIn ? '' : 'style="pointer-events:none; opacity:0.35;"';

    tbody.insertAdjacentHTML('beforeend', `
      <tr class="${rowClass}">
        <td style="white-space: nowrap;">${r.date}</td>
        <td style="font-weight: 500;">${r.type}</td>
        <td>${r.content}</td>
        <td style="text-align:right; font-weight: bold;">${fmt(r.amount)}</td>
        <td style="text-align:center" onclick="if(!isLoggedIn) showToast('Y√™u c·∫ßu ƒëƒÉng nh·∫≠p', '#e67e22')">
          <button class="${disClass}" ${loginTitle} ${pointerStyle} onclick="openEditModal('${r.id}')">‚úèÔ∏è</button>
          <button class="${disClass}" ${loginTitle} ${pointerStyle} onclick="del('${r.id}')">üóë</button>
        </td>
      </tr>
    `);
  });
}

/* ============================================================
   4. T√åM KI·∫æM & TR·∫†NG TH√ÅI N√öT (SEARCH & UI STATE)
   ============================================================ */
function searchTable(){
  const k = $('searchBox').value.toLowerCase();
  document.querySelectorAll('#tb tr').forEach(tr=>{
    tr.style.display = tr.innerText.toLowerCase().includes(k) ? '' : 'none';
  });
}

function updateAddBtn() {
  const btnAdd = $('btnAdd');
  const btnSheet = $('sheetLink');
  const loginMsg = "Y√™u c·∫ßu ƒëƒÉng nh·∫≠p";

  if (isLoggedIn) {
    if (btnAdd) {
      btnAdd.classList.remove('disabled');
      btnAdd.disabled = false;
      btnAdd.title = "";
    }
    if (btnSheet) {
      btnSheet.classList.remove('disabled');
      btnSheet.style.pointerEvents = "auto";
      btnSheet.style.opacity = "1";
      btnSheet.title = "";
    }
  } else {
    if (btnAdd) {
      btnAdd.classList.add('disabled');
      btnAdd.disabled = true;
      btnAdd.title = loginMsg;
      btnAdd.parentElement.onclick = () => { if(!isLoggedIn) showToast(loginMsg, "orange"); };
    }
    if (btnSheet) {
      btnSheet.classList.add('disabled');
      btnSheet.style.pointerEvents = "none";
      btnSheet.style.opacity = "0.5";
      btnSheet.title = loginMsg;
    }
  }
}

/* ============================================================
   5. TH√äM, S·ª¨A, X√ìA D·ªÆ LI·ªÜU (CRUD OPERATIONS)
   ============================================================ */
function openModal(){
  if(!isLoggedIn) return alert('C·∫ßn ƒëƒÉng nh·∫≠p');
  editId = null;
  $('modalTitle').innerText = 'Th√™m d·ªØ li·ªáu';
  $('m_date').value = new Date().toISOString().slice(0,10);
  $('m_type').value = 'Thu';
  $('m_content').value = '';
  $('m_amount').value = '';
  $('modalForm').classList.add('active');
}

function openEditModal(id){
  if(!isLoggedIn) return;
  google.script.run.withSuccessHandler(d=>{
    if(!d) return alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu');
    editId = d.id;
    $('modalTitle').innerText = 'S·ª≠a d·ªØ li·ªáu';
    $('m_date').value = d.date;
    $('m_type').value = d.type;
    $('m_content').value = d.content;
    $('m_amount').value = d.amount;
    $('modalForm').classList.add('active');
  }).getItemById(id);
}

function modalSave(){
  if(!isLoggedIn) return;
  const o = {
    id: editId,
    date: $('m_date').value,
    type: $('m_type').value,
    content: $('m_content').value,
    amount: Number($('m_amount').value)
  };
  const fn = editId ? 'updateRow' : 'addRow';
  const msg = editId ? 'ƒê√£ c·∫≠p nh·∫≠t' : 'ƒê√£ th√™m d·ªØ li·ªáu th√†nh c√¥ng';
  const color = editId ? '#2563eb' : '#16a34a';

  google.script.run.withSuccessHandler(()=>{
    closeModal();
    loadAll();
    showToast(msg, color);
  })[fn](o);
}

function closeModal(){
  $('modalForm').classList.remove('active');
}

function closeModalOutside(e){
  if(e.target.id === 'modalForm') closeModal();
}

function del(id){
  if(!isLoggedIn) return;
  if(!confirm('Ch·∫Øc ch·∫Øn x√≥a d√≤ng n√†y?')) return;
  google.script.run.withSuccessHandler(() => {
    loadAll();
    showToast("ƒê√£ x√≥a d·ªØ li·ªáu", "#dc2626");
  }).deleteRow(id);
}

/* ============================================================
   6. LOGIC B·ªò L·ªåC N√ÇNG CAO (FILTER SYSTEM)
   ============================================================ */
function initFilterDropdowns() {
  const yearSelect = $('f_year');
  const monthFrom = $('f_month_from');
  const monthTo = $('f_month_to');

  if (yearSelect) {
    yearSelect.innerHTML = '';
    const currentYear = new Date().getFullYear();
    for (let i = currentYear - 5; i <= currentYear + 5; i++) {
      let opt = document.createElement('option');
      opt.value = i; opt.innerHTML = i;
      if (i === currentYear) opt.selected = true;
      yearSelect.appendChild(opt);
    }
  }

  if (monthFrom && monthTo) {
    monthFrom.innerHTML = ''; monthTo.innerHTML = '';
    for (let i = 1; i <= 12; i++) {
      let optFrom = document.createElement('option');
      let optTo = document.createElement('option');
      optFrom.value = i; optFrom.innerHTML = 'Th√°ng ' + i;
      optTo.value = i; optTo.innerHTML = 'Th√°ng ' + i;
      monthFrom.appendChild(optFrom);
      monthTo.appendChild(optTo);
    }
    const currentMonth = new Date().getMonth() + 1;
    monthFrom.value = currentMonth;
    monthTo.value = currentMonth;
  }
}

function onModeChange() {
  const mode = $('f_mode').value;
  const config = {
    'f_date_from_row': ['date', 'range'],
    'f_date_to_row': ['range'],
    'f_year_row': ['month', 'quarter', 'year'],
    'f_month_from_row': ['month'],
    'f_month_to_row': ['month'],
    'f_quarter_row': ['quarter']
  };

  for (let id in config) {
    const el = $(id);
    if (el) el.style.display = config[id].includes(mode) ? 'block' : 'none';
  }

  const lblFrom = $('lbl_from');
  if (lblFrom) lblFrom.innerText = (mode === 'range') ? 'T·ª´ ng√†y' : 'Ng√†y';
}

function applyFilter() {
  const filterData = {
    type: $('f_type').value,
    mode: $('f_mode').value,
    dateFrom: $('f_from').value,
    dateTo: $('f_to').value,
    year: $('f_year').value,
    monthFrom: $('f_month_from').value,
    monthTo: $('f_month_to').value,
    quarter: $('f_quarter').value
  };

  const btn = event.currentTarget;
  const originalText = btn.innerText;
  btn.innerText = "ƒêang l·ªçc...";
  btn.disabled = true;

  google.script.run
    .withSuccessHandler(function(data) {
      renderTable(data); 
      btn.innerText = originalText;
      btn.disabled = false;
      showToast("ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu b·ªô l·ªçc");
    })
    .withFailureHandler(function(err) {
      btn.innerText = originalText;
      btn.disabled = false;
      showToast("L·ªói: " + err.message, "red");
    })
    .getDataFromServer(filterData); 
}

function clearFilter() {
  if($('searchBox')) $('searchBox').value = '';
  if($('f_type')) $('f_type').value = '';
  if($('f_mode')) $('f_mode').value = 'all';
  
  onModeChange(); 
  if (lastRows && lastRows.length > 0) {
    renderTable(lastRows); 
  } else {
    loadAll();
  }
  showToast("ƒê√£ x√≥a t·∫•t c·∫£ b·ªô l·ªçc");
}

/* ============================================================
   7. XU·∫§T D·ªÆ LI·ªÜU (EXPORT EXCEL & PDF)
   ============================================================ */
function exportExcel() {
  try {
    const data = [];

    // 1. Th√™m Ti√™u ƒë·ªÅ b√°o c√°o (G·ªôp √¥ s·∫Ω l√†m ·ªü b∆∞·ªõc sau)
    data.push(["B√ÅO C√ÅO THU CHI"]); 
    data.push([]); // D√≤ng tr·ªëng ƒë·ªÉ gi√£n c√°ch

    // 2. Th√™m Ti√™u ƒë·ªÅ c·ªôt
    data.push(["Ng√†y th√°ng", "Lo·∫°i", "N·ªôi dung", "S·ªë ti·ªÅn"]);

    // 3. L·∫•y d·ªØ li·ªáu t·ª´ th·∫ª <tbody> (N∆°i ch·ª©a c√°c h√†ng r.date, r.type...)
    // Thay 'tb' b·∫±ng ID ch√≠nh x√°c c·ªßa th·∫ª <tbody> trong HTML c·ªßa b·∫°n
    const tbody = document.getElementById("tb");
    const rows = tbody.querySelectorAll("tr");

    if (rows.length === 0) {
      showToast("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!", "#e67e22");
      return;
    }

    // 4. L·∫∑p qua t·ª´ng h√†ng ƒë·ªÉ l·∫•y 4 c·ªôt ƒë·∫ßu ti√™n
    rows.forEach(row => {
      const cols = row.querySelectorAll("td");
      // Ch·ªâ l·∫•y d·ªØ li·ªáu n·∫øu h√†ng c√≥ ƒë·ªß s·ªë c·ªôt
      if (cols.length >= 4) {
        data.push([
          cols[0].innerText.trim(), // Ng√†y
          cols[1].innerText.trim(), // Lo·∫°i
          cols[2].innerText.trim(), // N·ªôi dung
          cols[3].innerText.trim()  // S·ªë ti·ªÅn (d·∫°ng vƒÉn b·∫£n c√≥ d·∫•u ph√¢n c√°ch)
        ]);
      }
    });

    // 5. T·∫°o Worksheet t·ª´ m·∫£ng d·ªØ li·ªáu (Array of Arrays)
    const ws = XLSX.utils.aoa_to_sheet(data);

    // 6. C·∫•u h√¨nh g·ªôp √¥ cho ti√™u ƒë·ªÅ "B√ÅO C√ÅO THU CHI" (H√†ng 1, t·ª´ C·ªôt A ƒë·∫øn D)
    ws['!merges'] = [
      { s: { r: 0, c: 0 }, e: { r: 0, c: 3 } }
    ];

    // 7. ƒê·ªãnh d·∫°ng ƒë·ªô r·ªông c·ªôt (wch: width character)
    ws['!cols'] = [
      { wch: 15 }, // Ng√†y
      { wch: 10 }, // Lo·∫°i
      { wch: 40 }, // N·ªôi dung
      { wch: 15 }  // S·ªë ti·ªÅn
    ];

    // 8. T·∫°o Workbook v√† t·∫£i file
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "B√°o c√°o");
    
    const dateStr = new Date().toISOString().slice(0, 10);
    XLSX.writeFile(wb, `Bao_Cao_Thu_Chi_${dateStr}.xlsx`);

    showToast("ƒê√£ xu·∫•t b√°o c√°o th√†nh c√¥ng!", "#16a34a");
  } catch (e) {
    console.error("L·ªói Excel:", e);
    alert("Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu b·∫£ng. H√£y ki·ªÉm tra ID 'tb'");
  }
}

function exportPDF() {
  const element = document.querySelector('table');
  const win = window.open('', '', 'height=700,width=900');
  win.document.write('<html><head><title>Xu·∫•t PDF</title>');
  win.document.write('<style>table { width: 100%; border-collapse: collapse; font-size: 12px; } th, td { border: 1px solid black; padding: 4px; text-align: left; } .tr-chi td { color: red; }</style>');
  win.document.write('</head><body>');
  win.document.write('<h3>DANH S√ÅCH THU CHI</h3>');
  win.document.write(element.outerHTML);
  win.document.write('</body></html>');
  win.document.close();
  setTimeout(() => win.print(), 500);
}

/* ============================================================
   8. TH√îNG B√ÅO & KH·ªûI T·∫†O (TOAST & INIT)
   ============================================================ */
function showToast(msg, color = "#333") {
  const toast = $('toast');
  if (toast) {
    toast.innerText = msg;
    toast.style.backgroundColor = color;
    toast.className = "toast show";
    setTimeout(() => { toast.className = "toast"; }, 3000);
  }
}

window.addEventListener('DOMContentLoaded', () => {
  updateAddBtn();
  loadAll();
  initFilterDropdowns();
  onModeChange(); 
});
</script>